#ks=RHEL9
text
keyboard 'us'
lang en_US.UTF-8
skipx

# Network configuration for cappy1
network --bootproto=static --device=link --ip=192.168.50.71 --netmask=255.255.255.0 --gateway=192.168.50.1 --nameserver=192.168.50.1,8.8.8.8 --hostname=cappy1 --activate

# Set root password (change 'your-strong-root-password'!)
rootpw --plaintext your-strong-root-password

# Create the captcrunch user with the password '122'
user --name=captcrunch --password=122 --plaintext --groups=wheel

# Disable password authentication for SSH (keys only) and add NOPASSWD sudo
# This runs after the installation is complete but before the first reboot
%post --log=/root/ks-post.log
echo "Disabling SSH password authentication..."
# Disable PasswordAuthentication
sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

echo "Setting up sudo for captcrunch..."
# Add NOPASSWD: ALL for the 'wheel' group
echo "%wheel   ALL=(ALL)   NOPASSWD: ALL" >> /etc/sudoers.d/wheel-nopasswd

echo "Adding SSH key for captcrunch..."
# Create the .ssh directory for captcrunch
mkdir -p /home/captcrunch/.ssh
chmod 700 /home/captcrunch/.ssh

# ---!!! PASTE YOUR PUBLIC KEY HERE !!!---
echo "YOUR_SSH_PUBLIC_KEY_HERE" >> /home/captcrunch/.ssh/authorized_keys
# ---!!! END PUBLIC KEY ---!!!

# Set correct permissions
chmod 600 /home/captcrunch/.ssh/authorized_keys
chown -R captcrunch:captcrunch /home/captcrunch/.ssh

%end

# Disk partitioning
# This will WIPE the nvme drive and the sata hdd
# It uses the 256gb nvme drive for the OS (/, /boot, swap)
# It uses the 1tb hdd for /mnt/storage
zerombr
clearpart --all --initlabel

# NVMe drive for OS
part /boot --fstype=xfs --size=1024 --ondisk=nvme0n1
part swap --size=8192 --ondisk=nvme0n1  # 8GB swap
part / --fstype=xfs --grow --size=1 --ondisk=nvme0n1

# 1TB HDD for data
part /mnt/storage --fstype=xfs --grow --size=1 --ondisk=sda

# Set timezone
timezone America/New_York --utc

# Package selection (minimal install + extras for your lab)
%packages
@minimal-environment
@standard
kexec-tools
nfs-utils
samba
podman
cockpit
cockpit-machines
libvirt-client
qemu-kvm
%end

# Finalize setup
reboot
